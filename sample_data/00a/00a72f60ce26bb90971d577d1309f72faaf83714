#  Calculating VaR conditional on market regime ['calm', 'turbulent' or 'full period']
#
#  Regime = Kritzman's measure of turbulence
#
#
#
#
d.turbulence.VaR.data <- function(datareturns, wgts){
  ans <- matrix(0, ncol = 1, nrow = dim(datareturns)[1])
  datareturns.cov <- cov(datareturns)
  df <- dim(datareturns)[2]
  for(i in 1:dim(datareturns)[1]){
    ans[i] <- (datareturns[i,]- colMeans(datareturns)) %*% solve(datareturns.cov) %*% t(datareturns[i,]- colMeans(datareturns))
  }
  VaR.calm       <- VaR(datareturns[ans <= qchisq(0.75, df = df)], p = 0.95, weights = wgts, portfolio_method = 'component')$MVaR
  VaR.stressed   <- VaR(datareturns[ans >  qchisq(0.75, df = df)], p = 0.95, weights = wgts, portfolio_method = 'component')$MVaR
  VaR.fullperiod <- VaR(datareturns, weights = wgts, p = 0.95, portfolio_method = 'component')$MVaR
  VaRresults <- list('tranquil VaR' = VaR.calm,
                     'turbulent VaR' = VaR.stressed,
                     'full period VaR' = VaR.fullperiod)
  return(VaRresults)
}