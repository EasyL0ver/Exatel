<html>
<head>
<?php
@header('P3P: CP="CAO COR CURa ADMa DEVa OUR IND ONL COM DEM PRE"');
require_once 'config.php';
session_start();
?>
<script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="js/jquery.qtip-1.0.0.min.js"></script>
<style type="text/css">
  a:link {
    COLOR: #A9A9A9;
  }
  a:visited {
    COLOR: #A9A9A9;
  }
  a:hover {
    COLOR: #A9A9A9;
  }
  a:active {
    COLOR: #A9A9A9;
  }
</style>
</head>
<body>
<?php
$username = $_SESSION['voteuser'];
$site = $_GET['site'];
if ($username == "" && $site=="") {
  if($_POST) {
    $postuser = $_POST['Username'];
    $_SESSION['voteuser'] = $postuser;
    $username = $_SESSION['voteuser'];
  } else {
    ?>
    <center><font face="Comic Sans MS" color="white">Please log in to vote</font>
    <form method="post" action="">
    <input type="text" id="Username" name="Username" value="">
    <input type="submit" class="submit" value="Login"/>
    </form>
    </center><br><br>
        <?php
  }
}
if (!$username == "") {
  if(isset($_POST['redeem'])) {
    $conn = mysql_connect($dbhost,$dbuser,$dbpass)
      or die ('Error connecting to mysql');
    mysql_select_db($dbname);
    
    $query = sprintf("SELECT COUNT(username) FROM users WHERE UPPER(username) = UPPER('%s')", mysql_real_escape_string($_SESSION['voteuser']));
    $result = mysql_query($query);
    $query="SELECT * FROM vote_users";
    $result=mysql_query($query);
    $num=mysql_numrows($result);
    $i=0;
    while ($i < $num) {
      $user = mysql_result($result,$i,"username");
      $points = mysql_result($result,$i,"pointsleft");
      if(strtoupper($user)==strtoupper($_SESSION['voteuser'])) {
        $voting = $points;
      }
      $i++;
    }
    if($voting == "" || $voting == "0") {
      echo '<center><font face="Comic Sans MS" color="darkred"><b>You do not have anything to redeem.</b></font></center><br>';
    } else {
      $user = $_SESSION['voteuser'];
      
      $query = sprintf("UPDATE vote_users SET pointsleft = 0 WHERE UPPER(username) = UPPER('%s')",
        mysql_real_escape_string($user));
      mysql_query($query);
      
      $i=1;
      while($i < $commands+1) {
        $cmd = $command[$i];
        $cmd = str_replace("%user%",$user,$cmd);
        $cmd = str_replace("%points%",$voting,$cmd);
        $query = sprintf("INSERT INTO vote_tasks(user,command) VALUES ('$user','$cmd')");
               mysql_query($query);
        $i++;
      }
      
      echo '<center><font face="Comic Sans MS" color="darkgreen"><b>You have redeemed '.$voting.' '.$itemname.'!</b></font></center><br>';
    }
  }
  
  $conn = mysql_connect($dbhost,$dbuser,$dbpass)
    or die ('Error connecting to mysql');
  mysql_select_db($dbname);
  
  if (!empty($_SERVER['HTTP_CLIENT_IP'])){
    $ip=$_SERVER['HTTP_CLIENT_IP'];
  }elseif (!empty($_SERVER['HTTP_X_FORWARDED_FOR'])){
    $ip=$_SERVER['HTTP_X_FORWARDED_FOR'];
  }else{
    $ip=$_SERVER['REMOTE_ADDR'];
  }
  $ip = ip2long($ip);
  
  $query=" SELECT * FROM vote_ips WHERE ip='$ip'";
  $result=mysql_query($query);
  $num=mysql_numrows($result);
  
  $i=0;
  $ii=1;
  while ($i < $num) {
    while ($ii < $votingsites+1) {
      $ipvoted[$ii]=mysql_result($result,$i,$votingdbname[$ii]);
      $ii++;
    }
    $i++;
  }
  
  if (mysql_numrows($result) == 0) {
    $query = sprintf("INSERT INTO vote_ips(ip) VALUES ('$ip')");
    mysql_query($query);
  }

  $query=" SELECT * FROM vote_users WHERE UPPER(username)=UPPER('$username')";
  $result=mysql_query($query);
  $num=mysql_numrows($result);

  $i=0;
  $ii=1;
  while ($i < $num) {
    while ($ii < $votingsites+1) {
      $voted[$ii]=mysql_result($result,$i,$votingdbname[$ii]);
      $ii++;
    }
    $i++;
  }

  if ($site=="") {
    echo '<center><table><tr><td><font face="Comic Sans MS" color="white">Welcome '.$username.'</font><br><font face="Comic Sans MS" color="darkgrey">Not you? <a href="'.$voterlink.'?site=Logout">Logout</a></font></td></tr></table><br>';
    $ii=1;
    while ($ii < $votingsites+1) {
      if (time() >= strtotime($voted[$ii]) + 86400 && time() >= strtotime($ipvoted[$ii]) + 86400) {
        ?>
         <button id="<?php echo $votingname[$ii]; ?>" onclick="var url = '<?php echo $voterlink; ?>?site=<?php echo $votingname[$ii]; ?>'; $('#<?php echo $votingname[$ii]; ?>').attr('disabled','disabled'); window.open(url,'The Mining Town','status=1,height=800,width=1000,resizable=1'); window.history.go(0); " style="width:200px;" type="button"><?=$votingname[$ii];?></button><br>
               <?php 
      } else {
        if(strtotime($voted[$ii]) >= strtotime($ipvoted[$ii])) {
          $votetime = strtotime($voted[$ii]);
        } else {
          $votetime = strtotime($ipvoted[$ii]);
        }

        $now = time();
        $datediff = ($now - $votetime - 86400) * (-1);
    
            $padHours = false;
            $hms = "";
            $hours = intval(intval($datediff) / 3600); 
            $hms .= ($padHours) 
                  ? str_pad($hours, 2, "0", STR_PAD_LEFT). ":"
                  : $hours. ":";
            $minutes = intval(($datediff / 60) % 60); 
            $hms .= str_pad($minutes, 2, "0", STR_PAD_LEFT). ":";
            $seconds = intval($datediff % 60); 
        $hms .= str_pad($seconds, 2, "0", STR_PAD_LEFT);

        ?>
        <button disabled="disabled" style="width:200px;" type="button">Vote again in: <?php echo $hms; ?></button></a><br>
               <?php
      }
      $ii++;
    } ?>
      <form>
    <input type="hidden" id="redeem" name="redeem" value="redeem">
    <input type="image" class="submit" src="images/redeem.png"/>
  </form>
  </center>

    <?php
  } elseif ($site=="Logout") {
    if ($_SESSION['voteuser'] != "") {
      session_destroy();
      echo '<script>document.location.replace("'.$voterlink.'");</script>';
    } else {
      session_destroy();
      echo '<script>document.location.replace("'.$voterlink.'");</script>';
    }
  } else {
    $ii=1;
    while ($ii < $votingsites+1) {
      if($site == $votingname[$ii]) {
        if (time() >= strtotime($voted[$ii]) + 86400 && time() >= strtotime($ipvoted[$ii]) + 86400) {
          $query2 = sprintf("SELECT COUNT(username) FROM vote_users WHERE UPPER(username) = UPPER('%s')", mysql_real_escape_string($username));
          $result2 = mysql_query($query2);
          list($count2) = mysql_fetch_row($result2);
      
          if(!$count2 == 1) {
            $query = sprintf("INSERT INTO vote_users(username) VALUES ('$username')");
            mysql_query($query);
          }
          $votingdb = $votingdbname[$ii];
          
          $query = sprintf("UPDATE vote_users SET $votingdb = NOW() WHERE UPPER(username) = UPPER('%s')",
          mysql_real_escape_string($username));
          mysql_query($query);
          $query = sprintf("UPDATE vote_ips SET $votingdb = NOW() WHERE ip = '$ip'");
          mysql_query($query);
          $query = sprintf("UPDATE vote_users SET points = points+1 WHERE UPPER(username) = UPPER('%s')",
          mysql_real_escape_string($username));
          mysql_query($query);
          $query = sprintf("UPDATE vote_users SET pointsleft = pointsleft+$voteamount WHERE UPPER(username) = UPPER('%s')",
          mysql_real_escape_string($username));
          mysql_query($query);
          echo '<META HTTP-EQUIV="Refresh" Content="0; URL='.$votinglink[$ii].'">';
        } else {
          echo 'You have already voted for the server in the last 24 hours.<br>';
          echo 'If you did not vote somebody on the same IP as you might have voted already.';
        }
      }
      $ii++;
    }
  }
}

if($site=="") {
  $conn = mysql_connect($dbhost,$dbuser,$dbpass)
    or die ('Error connecting to mysql');
  mysql_select_db($dbname);
  
  $query="SELECT * FROM vote_users ORDER BY points DESC";
  $result=mysql_query($query);
  $num=mysql_numrows($result);
  $i=0;
  $yourpoints=0;
  $rank=0;
  while ($i < $num) {
    $rank++;
    $user=mysql_result($result,$i,"username");
    $points=mysql_result($result,$i,"points");
    if(strtolower($user) == strtolower($username)) {
      $yourpoints = $points;
      $yourrank = $rank;
    }
    $i++;
  }
  if($username == "") {
    echo '<center><img src="images/topvoters.png"></center>';
  } else {
    echo '<center><a href="" title="You are rank '.$yourrank.' with '.$yourpoints.' votes."><img src="images/topvoters.png"></a></center><br>';
  }
  echo '<table>';
  if($num >= 3) {
    $num = 3;
  }
  $i=0;
  while ($i < $num) {
    $user=mysql_result($result,$i,"username");
    $points=mysql_result($result,$i,"points");
    echo '<tr><td><font face="Comic Sans MS" color="white">'.$user.'</font><br>'; 
    echo '<font face="Comic Sans MS" color="darkgrey" size="2">With '.$points.' votes.</font></td></tr>';
    $i++;
  }
  if($num < 3) {
    while($num < 3) {
      echo '<tr><td><font face="Comic Sans MS" color="white">Nobody</font><br>'; 
      echo '<font face="Comic Sans MS" color="darkgrey" size="2">With 0 votes.</font></td></tr>';
      $num++;
    }
  }
  echo '</table>';
}
?>
</body>
</html>