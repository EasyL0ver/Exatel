import logging
from contextlib import contextmanager

from sqlalchemy.exc import IntegrityError


def cut_integrity_error_details(e: IntegrityError) -> IntegrityError:
    if len(e.params) > 256:
        e.params = ['DEBUG: params have been removed due too big length']
    if len(e.statement) > 1024:
        e.statement = ''.join([
            e.statement[:512],
            ' ... DEBUG: statement has been cut off due too big length ... ',
            e.statement[-512:]
        ])
    return e


@contextmanager
def log_exceptions(logger: logging.Logger):
    try:
        yield
    except IntegrityError as e:
        e = cut_integrity_error_details(e)
        logger.exception(e)
        raise
    except Exception as e:
        logger.exception(e)
        raise