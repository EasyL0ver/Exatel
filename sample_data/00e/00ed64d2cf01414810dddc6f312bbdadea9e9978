SELECT
CONCAT(SUBSTR(r.created,0,7),'-01') AS MONTH,
p.adf_2_0,
CASE
    WHEN p.is_managed = 1 THEN 'managed'
    ELSE 'non_managed'
    END AS Portfolio,
CASE 
    WHEN r.hotel_cc1 = r.booker_cc1 THEN 'domestic'
    ELSE 'outbound'
    END AS Domestic_Outbound,
CASE
    WHEN p.is_genius = 1 THEN 'genius'
    ELSE 'non_genius'
    END AS Member,
CASE  
	  WHEN t.travel_purpose = 'business' THEN 'tp_business'  
	  WHEN t.travel_purpose = 'leisure' THEN 'tp_leisure'  
	  ELSE 'tp_unknown' 
	  END AS travel_purpose,  
CASE	  
      WHEN d.device_class = 'desktop' THEN 'desktop'	  
      WHEN d.device_class IN ('mobile','tablet') THEN 'mobile'	  
      ELSE 'other'
      END AS device,
st.site_type,
s.mapping2 AS app_nonapp,
r.booker_cc1,
COUNT(r.hotelreservation_id) AS TR,
SUM(r.roomnights) AS RNs,
SUM(r.price_active_currency) AS TTV_ac,
SUM(r.price_euro) AS TTV_EUR,
SUM(r.commission_amount_active_currency) AS comm_AC,
SUM(r.commission_amount_euro) AS comm_EUR,
CURRENT_TIMESTAMP()
 
FROM
fpa.transactions_detail r
JOIN reporting.property_splits p ON r.hotel_id = p.hotel_id
JOIN bbbi.hotelreservation_flat_bb t ON r.transaction_id = t.transaction_id
JOIN fpa.device_class_lookup d ON d.hotelreservation_id = r.hotelreservation_id	
JOIN fpa.site_type_lookup st ON r.hotelreservation_id = st.hotelreservation_id
JOIN fpa.site_type_translation s ON s.site_type = st.site_type
 
 
WHERE 
 
to_date(r.created) >= '2015-01-01'
AND r.booker_cc1 IN ('id', 'vn','ph','my','th', 'sg', 'br','ar', 'co', 'ru', 'ro', 'cz', 'pl')
AND r.STATUS NOT IN ('test','fraudulent')
GROUP BY 1,2,3,4,5,6,7,8,9,10
 
UNION ALL
 
SELECT
 
CONCAT(SUBSTR(r.date_cancelled,0,7),'-01') AS MONTH,
p.adf_2_0,
CASE
    WHEN p.is_managed = 1 THEN 'managed'
    ELSE 'non_managed'
    END AS Portfolio,
CASE 
    WHEN r.hotel_cc1 = r.booker_cc1 THEN 'domestic'
    ELSE 'outbound'
    END AS Domestic_Outbound,
CASE
    WHEN p.is_genius = 1 THEN 'genius'
    ELSE 'non_genius'
    END AS Member,
CASE  
	  WHEN t.travel_purpose = 'business' THEN 'tp_business'  
	  WHEN t.travel_purpose = 'leisure' THEN 'tp_leisure'  
	  ELSE 'tp_unknown' 
	  END AS travel_purpose,  
CASE	  
      WHEN d.device_class = 'desktop' THEN 'desktop'	  
      WHEN d.device_class IN ('mobile','tablet') THEN 'mobile'	  
      ELSE 'other'
      END AS device,
st.site_type,
s.mapping2 AS app_nonapp,
r.booker_cc1,
-COUNT(r.hotelreservation_id) AS TR,
-SUM(r.roomnights) AS RNs,
-SUM(r.price_active_currency) AS TTV_ac,
-SUM(r.price_euro) AS TTV_EUR,
-SUM(r.commission_amount_active_currency) AS comm_AC,
-SUM(r.commission_amount_euro) AS comm_EUR,
CURRENT_TIMESTAMP()
 
FROM
fpa.transactions_detail r
JOIN reporting.property_splits p ON r.hotel_id = p.hotel_id
JOIN bbbi.hotelreservation_flat_bb t ON r.transaction_id = t.transaction_id
JOIN fpa.device_class_lookup d ON d.hotelreservation_id = r.hotelreservation_id	
JOIN fpa.site_type_lookup st ON r.hotelreservation_id = st.hotelreservation_id
JOIN fpa.site_type_translation s ON s.site_type = st.site_type
 
WHERE 
 
to_date(r.date_cancelled) >= '2015-01-01'
AND r.booker_cc1 IN ('id', 'vn','ph','my','th', 'sg', 'br','ar', 'co', 'ru', 'ro', 'cz', 'pl')
AND r.STATUS NOT IN ('ok', 'test','fraudulent')
GROUP BY 1,2,3,4,5,6,7,8,9,10
;