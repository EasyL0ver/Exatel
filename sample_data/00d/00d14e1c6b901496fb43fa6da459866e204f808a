select t.* from ( select * from ( select t.*
      ,NULLIF(round(t.nClosedManHour / t.nNormManHour * 100, 2), 0) as nClosedManHourPrc
      ,NULLIF(t.nNormManHour - t.nClosedManHour, 0) as nRemManHour
      ,NULLIF(round(100 - (t.nClosedManHour / t.nNormManHour * 100), 2), 0) as nRemManHourPrc
      ,case when t.sFioConfirmSign is not null then decode(t.bConfirmSignNonActual,0,'#GreenFill',1,'#MagentaFill',null) end as sConfirmSignStyle
      ,case when t.sFioConfirmSign is not null then decode(t.bConfirmSignNonActual,0,1,1,4,null) end as nConfirmSignImage
      ,case when t.sFioAcceptSign is not null then decode(t.bAcceptSignNonActual,0,'#GreenFill',1,'#MagentaFill',null) end as sAcceptSignStyle
      ,case when t.sFioAcceptSign is not null then decode(t.bAcceptSignNonActual,0,1,1,4,null) end as nAcceptSignImage
      ,case when t.sFioFamiliarSign is not null then decode(t.bFamiliarSignNonActual,0,'#GreenFill',1,'#MagentaFill',null) end as sFamiliarSignStyle
      ,case when t.sFioFamiliarSign is not null then decode(t.bFamiliarSignNonActual,0,1,1,4,null) end as nFamiliarSignImage
       -- подписи процентовок
      ,case when t.sFioConfirmSignPerc1 is not null then decode(t.bConfirmSignNonActualPerc1,0,'#GreenFill',1,'#MagentaFill',null) end as sConfirmSignStylePerc1
      ,case when t.sFioConfirmSignPerc1 is not null then decode(t.bConfirmSignNonActualPerc1,0,1,1,4,null) end as nConfirmSignImagePerc1
      ,case when t.sFioAcceptSignPerc1 is not null then decode(t.bAcceptSignNonActualPerc1,0,'#GreenFill',1,'#MagentaFill',null) end as sAcceptSignStylePerc1
      ,case when t.sFioAcceptSignPerc1 is not null then decode(t.bAcceptSignNonActualPerc1,0,1,1,4,null) end as nAcceptSignImagePerc1
      ,case when t.sFioConfirmSignPerc2 is not null then decode(t.bConfirmSignNonActualPerc2,0,'#GreenFill',1,'#MagentaFill',null) end as sConfirmSignStylePerc2
      ,case when t.sFioConfirmSignPerc2 is not null then decode(t.bConfirmSignNonActualPerc2,0,1,1,4,null) end as nConfirmSignImagePerc2
      ,case when t.sFioAcceptSignPerc2 is not null then decode(t.bAcceptSignNonActualPerc2,0,'#GreenFill',1,'#MagentaFill',null) end as sAcceptSignStylePerc2
      ,case when t.sFioAcceptSignPerc2 is not null then decode(t.bAcceptSignNonActualPerc2,0,1,1,4,null) end as nAcceptSignImagePerc2
      ,case when t.sFioConfirmSignPerc3 is not null then decode(t.bConfirmSignNonActualPerc3,0,'#GreenFill',1,'#MagentaFill',null) end as sConfirmSignStylePerc3
      ,case when t.sFioConfirmSignPerc3 is not null then decode(t.bConfirmSignNonActualPerc3,0,1,1,4,null) end as nConfirmSignImagePerc3
      ,case when t.sFioAcceptSignPerc3 is not null then decode(t.bAcceptSignNonActualPerc3,0,'#GreenFill',1,'#MagentaFill',null) end as sAcceptSignStylePerc3
      ,case when t.sFioAcceptSignPerc3 is not null then decode(t.bAcceptSignNonActualPerc3,0,1,1,4,null) end as nAcceptSignImagePerc3
  from (
    select t.ID
          ,t.idClass
          ,t.sCode
          ,t.dIssueDate
          ,t.idBwfDocument, MES_JobOrderAPI.GetidBwfDocument_HL(t.idBwfDocument) as idBwfDocument_HL
          ,t.idState
          ,bs_personAPI.GetShortName(t.idPerson) as sJoPerson
          ,t.idShopMaster
          ,bs_personAPI.GetShortName(t.idShopMaster) as idShopMaster_HL
          ,t.idResource
          ,rss_resourceAPI.getMnemoCode(t.idResource) idResource_HL
          ,btk_convert.StringArrayToString4K(
             cast(
                multiset(
                  select distinct (select  bs_personAPI.GetShortName(tt.idPerson) from dual)
                    from mes_jobOrderPercent tt
                   where tt.idJobOrder = t.id
                ) as tvarchartable
              ), '; '
           ) as sJopPersonList
          ,(select RSS_ResourceAPI.Getmnemocode(t.idPerformer) from dual) as idPerformerMC
          ,(select bs_orderAPI.Getmnemocode(t.idBsOrder) from dual) as idBsOrderMC
          ,(select BTK_ClientGate.GetHeadLine(t.idState) from dual) as idState_HL
          ,(select RSS_ResourceAPI.Getmnemocode(t.idArea) from dual) as idAreaMC
          ,(select EAM_brigadeAPI.Getheadline(t.idBrigade) from dual) as idBrigade_HL
          ,t.sDescription

          ,(select sum(td.nNormManHour)
              from mes_joborderDet td
             where td.idJobOrder = t.id
            ) as nNormManHour

          ,(select sum(td.nManHour)
              from mes_joborderDet td
             where td.idJobOrder = t.id
           ) as nManHour
          /*   ,(select sum(oi.nManHour)
               from  mes_joborderDet td
               left join YANT_TechProcTotal yp on yp.id = td.idTechProcTotal
               left join mes_orderItem oi on oi.idSourceDoc = yp.idTS
                where td.idJobOrder = t.id
             ) as nManHour    */

        /*  ,(select sum(pd.nNormManHour)
              from mes_jobOrderPercentDet pd
                  ,Mes_Joborderpercent    p
             where p.idJobOrder = t.id
               and pd.idJobOrderPercent = p.id
               and nvl(p.bApproved, 0) = 1) as nClosedManHour */
           ,(select sum(
              (select sum(nvl(pd.nNormManHour, 0))
                 from mes_jobOrderPercentDet pd
                     ,mes_jobOrderPercent    p
                where pd.idjoborderdet = td.id
                  and pd.idjoborderpercent = p.id
                  and nvl(p.bApproved, 0) = 1
              )
            )
            from mes_joborderDet td
           where td.idJobOrder = t.id
           ) as nClosedManHour
          ,p1.dReport as dReport1
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = t.id
               and sd.idRefClass = t.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Confirm') from dual)
           ) as sFioConfirmSign
          ,s.bConfirmSignNonActual
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = t.id
               and sd.idRefClass = t.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Accept') from dual)
           ) as sFioAcceptSign
          ,s.bAcceptSignNonActual
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = t.id
               and sd.idRefClass = t.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Familiar') from dual)
           ) as sFioFamiliarSign
          ,s.bFamiliarSignNonActual
           -- подписи процентовок
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p1.id
               and sd.idRefClass = p1.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Confirm') from dual)
           ) as sFioConfirmSignPerc1
          ,sp1.bConfirmSignNonActual as bConfirmSignNonActualPerc1
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p1.id
               and sd.idRefClass = p1.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Accept') from dual)
           ) as sFioAcceptSignPerc1
          ,sp1.bAcceptSignNonActual as bAcceptSignNonActualPerc1
          ,p2.dReport as dReport2
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p2.id
               and sd.idRefClass = p2.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Confirm') from dual)
           ) as sFioConfirmSignPerc2
          ,sp2.bConfirmSignNonActual as bConfirmSignNonActualPerc2
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p2.id
               and sd.idRefClass = p2.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Accept') from dual)
           ) as sFioAcceptSignPerc2
          ,sp2.bAcceptSignNonActual as bAcceptSignNonActualPerc2
          ,p3.dReport as dReport3
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p3.id
               and sd.idRefClass = p3.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Confirm') from dual)
           ) as sFioConfirmSignPerc3
          ,sp3.bConfirmSignNonActual as bConfirmSignNonActualPerc3
          ,(select BTK_Convert.StringArrayToString4K(cast(collect(wf_getuserfio.GetFioBysSystemName(sd.slogin,0) order by sd.dsign) as tVarcharTable),',')
              from BTK_SignDoc sd
             where sd.idrefobject = p3.id
               and sd.idRefClass = p3.idClass
               and sd.idTypeSign = (select BTK_TypeSignAPI.FindByMnemocode('Accept') from dual)
           ) as sFioAcceptSignPerc3
          ,sp3.bAcceptSignNonActual as bAcceptSignNonActualPerc3
      from MES_JobOrder t
         