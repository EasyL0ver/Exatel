function Import-PfxCertificate 
{
    param
    (
        [String]$certPath,
        [String]$certRootStore = "localmachine",
        [String]$certStore = "My",
        $pfxPass = $null
    ) 
    $pfx = new-object System.Security.Cryptography.X509Certificates.X509Certificate2 

    if ($pfxPass -eq $null) 
    {
        $pfxPass = read-host "Password" -assecurestring
    } 

    $pfx.import($certPath,$pfxPass,"Exportable,PersistKeySet") 

    $store = new-object System.Security.Cryptography.X509Certificates.X509Store($certStore,$certRootStore) 
    $store.open("MaxAllowed") 
    $store.add($pfx) 
    $store.close() 
}

Import-PfxCertificate -certPath "d:Certificate.pfx"
	
function Import-NTDSCertificate {
[CmdletBinding()]
param(
    [Parameter(Mandatory)]
    [string]$PFXFile,

    [Parameter(Mandatory)]
    [string]$PFXPassword,

    #Remove certificate from LocalMachinePersonal certificate store
    [switch]$Cleanup
    )
    begin{
        Write-Verbose -Message "Importing PFX file."
        $PFXObject = New-Object -TypeName System.Security.Cryptography.X509Certificates.X509Certificate2
        $PFXObject.Import($PFXFile,$PFXPassword,[System.Security.Cryptography.X509Certificates.X509KeyStorageFlags]::Exportable)

        $thumbprint = $PFXObject[0].Thumbprint
    }
    process{
        Write-Verbose -Message "Importing certificate into LocalMachinePersonal"
        $certificateStore = New-Object -TypeName System.Security.Cryptography.X509Certificates.X509Store('My','LocalMachine')
        $certificateStore.Open('MaxAllowed')
        $certificateStore.Add($PFXObject)
        $certificateStore.Close()

        Write-Verbose -Message "Copying certificate from LocalMachinePersonal to NTDSPersonal"
        $copyParameters = @{
            'Path' = "HKLM:SoftwareMicrosoftSystemCertificatesMYCertificates$thumbprint"
            'Destination' = "HKLM:SOFTWAREMicrosoftCryptographyServicesNTDSSystemCertificatesMyCertificates$thumbprint"
            'Recurse' = $true
        }
        Copy-Item @copyParameters
    }
    end{
        if ($Cleanup){
            Write-Verbose -Message "Removing certificate from LocalMachinePersonal"
            $removalParameters = @{
                'Path' = "HKLM:SOFTWAREMicrosoftSystemCertificatesMYCertificates$thumbprint"
                'Recurse' = $true
            }
            Remove-Item @removalParameters
        }
    }