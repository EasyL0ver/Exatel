<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE muclient>
<!-- Saved on Monday, November 30, 2015, 8:44 PM -->
<!-- MuClient version 4.96 -->

<!-- Plugin "Aard_Who_Here" generated by Plugin Wizard -->

<muclient>
<plugin
   name="Aard_Who_Here"
   author="Endymion"
   id="a0a265102f5491d8eb1818a8"
   language="Lua"
   purpose="Show players in area."
   date_written="2015-11-30 20:44:07"
   requires="4.30"
   version="1.0"
   save_state="y"
   >
   <description trim="y">
<![CDATA[
-----------------------------------------------------------------------------
  This plugin will report to the comm log who is in the area.  It does not
  run in high traffic areas such as Aylor and a few common Clan halls.  The
  where list is checked every 3 seconds.  It is checked every 2 seconds when
  you are in a PK room.  The comm log is only updated if a player change is
  detected.  The online player list is updated every 2 minutes.
  
  wher                   Manually check/update where in comm log.
                          - Useful for Aylor before going into the Arena.
				
  whohere sound          Toggle sound on/off.
  
  whohere sound <file>   Change sound file.
                          - Use double \\ for directory.
        e.g. whohere sound C:\\Windows\\Media\\Windows Hardware Remove.wav

  whohere t[oggle]       Toggle the plugin on/off.
                          - Useful for epics.
									
-----------------------------------------------------------------------------  
]]>
   </description>
</plugin>


<!--  Get our standard constants -->

<include name="constants.lua"/>

<!--  Triggers  -->

<triggers>
  <trigger
   group="pagesize"
   enabled="n"
   regexp="y"
   match="^You do not page long messages\.$|^You currently display (?<lines>\d+) lines per page\.$"
   sequence="100"
   script="page_size"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   group="pagesize"
   enabled="n"
   regexp="y"
   match="^Use \'pagesize \<lines\>\' to change, or \'pagesize 0\' to disable (?<paging>paging)\.$|^$"
   sequence="100"
   script="end_page_size"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   name="trigger_who_where"
   regexp="y"
   match="^You are in area \: (.+)$|^Area created by \: (.+)$|^Level range is  \: (\d+) to (\d+)$"
   sequence="100"
   group="who_where"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   regexp="y"
   match="^Players near you\:$|^There are too many doors and fences to see who is in this (area)\.$"
   sequence="100"
   group="who_where"
   script="ready_player_list"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   regexp="y"
   match="^(?<player>\w+)\s\s+(?<room>.+)$"
   sequence="100"
   group="who_where_player"
   script="player_here"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   regexp="y"
   match="^$"
   sequence="100"
   name="end_player_list_trigger"
   script="end_player_list"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="n"
   regexp="y"
   match="^$"
   sequence="100"
   name="next_blank_line"
   script="next_blank_line"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   name="who_pk_list_catch"
   enabled="n"
   regexp="y"
   match="^                       Who list sorted by : Total .+$"
   script="enable_pk_list_catch"
   sequence="100"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   name="who_pk_list_end"
   enabled="n"
   regexp="y"
   match="^Players found\: \[(\d+)\], Max this reboot\: \[(\d+)\], Connections this reboot\: \[(\d+)\]$|^Players (invis)\: \[(\d+)\]\, Max on ever\: \[(\d+)\]$"
   script="enable_pk_list_catch"
   sequence="100"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   name="pk_list_line"
   enabled="n"
   regexp="y"
   match="^\[[\s]{0,2}(?<level>\d+)\s+(?<race>[a-zA-Z\-]+)\s+(?<remort>.+)\]\s\[\s+(?<stats>\d+)\s+\](?<xtra> [\(|\[|\*].+[\)|\]|\*])? (?<name>[a-zA-Z]{3,12}) (?<clan>.+)?$"
   script="pk_list_player"
   keep_evaluating="n"
   sequence="100"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   name="pk_list_line2"
   enabled="n"
   regexp="y"
   match="^\[.*\]\s\[\s+(?<stats>\d+)\s+\](?<xtra> [\(|\[|\*].+[\)|\]|\*])? (?<name>[a-zA-Z]{3,12}) (?<clan>.+)?$"
   script="pk_list_player"
   sequence="101"
   omit_from_output="y"
  >
  </trigger>
  <trigger
   enabled="y"
   regexp="y"
   match="^Welcome to Aardwolf\. May your adventures be mystical, challenging and rewarding\.$"
   script="go"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="y"
   regexp="y"
   match="^Regular (?<which>Game|Battle) Prompt\s+: (?<prompt>.+)$"
   script="prompt_gag_set"
   sequence="100"
  >
  </trigger>
  <trigger
   enabled="y"
   regexp="y"
   name="match_pdata"
   match="^this is set by function$"
   sequence="101"
   script="set_prompt"
   omit_from_output="n"
  >
  </trigger>
  <trigger
   enabled="y"
   regexp="y"
   name="match_prompt"
   match="^this is set by function$"
   sequence="100"
   script="set_prompt"
   omit_from_output="y"
   keep_evaluating="n"
  >
  </trigger>

</triggers>
<!--  Aliases  -->

<aliases>
	<alias
	match="^wher$"
	regexp="y"
	enabled="y"
	sequence="100"
	script="catch_where_list"
	>
	</alias>
	<alias
	   name="show_help"
	   regexp="y"
	   script="show_help"
	   match="^help who here$"
	   enabled="y"
	   sequence="100"
	  >
	</alias>
	<alias
	   name="toggle_sound"
	   regexp="y"
	   script="toggle_sound"
	   match="^whohere sound$"
	   enabled="y"
	   sequence="100"
	  >
	</alias>
	<alias
	   name="set_sound"
	   regexp="y"
	   script="set_sound"
	   match="^whohere sound (?<file>.+)$"
	   enabled="y"
	   sequence="100"
	  >
	</alias>
	<alias
		match="^whohere (t|to|tog|togg|toggl|toggle)$"
		regexp="y"
		enabled="y"
		sequence="100"
		script="disable_plugin"
	>
	</alias>
</aliases>

<!--  Timers  -->

<timers>
	<timer
		name="check_where_pk"
		enabled="n" 
		second="2" 
		offset_second="0.00"
		script="timer_check_where"
		group="whohere"
	>
	</timer>
	<timer
		name="check_where"
		enabled="n" 
		second="3" 
		offset_second="0.00"
		script="timer_check_where"
		group="whohere"
	>
	</timer>
	<timer
		name="check_players"
		enabled="n" 
		minute="2"
		offset_second="0.00"
		script="timer_check_players"
		group="whohere"
	>
	</timer>
</timers>

<!--  Script  -->

<script>
<![CDATA[
require "gmcphelper"
require "tprint"
dofile(GetInfo(60) .. "aardwolf_colors.lua")

local playsound = GetVariable("playsound") or "ON"
local players_here = {}
local zn = ""
local prev_zn = ""
local send_to_comm = true
local old_list = ""

local pdata = ""
local prompt = ""

local enemies = {["wolf"] = 1, ["amazon"] = 1, ["boot"] = 1, ["twinlobe"] = 1, ["shadokil"] = 1, ["dragon"] = 1, ["baal"] = 1, ["hook"] = 1, ["xunti"] = 1, ["imperium"] = 1, ["crimson"] = 1, ["pyre"] = 1, ["masaki"] = 1, ["rhabdo"] = 1, ["perdition"] = 1, ["cabal"] = 1, ["loqui"] = 1}
local friends = {["chaos"] = 1, ["emerald"] = 1, ["druid"] = 1, ["retribution"] = 1, ["watchmen"] = 1}
local all_players = {}

local char_base = 1
local char_status = 1
local char_maxstats = 1

local me = ""

local mystattotal = 1
local my_lvl = 1
local heresound = GetVariable("heresound") or "C:\\Windows\\Media\\Windows Hardware Remove.wav"

local dont = {aylor=1, dominion=1, academy=1, seekers=1, light=1, cabal=1, immhomes=1}

local pagesize = 0

local disabled = false

function OnPluginSaveState()
	SetVariable("playsound", playsound)
	SetVariable("heresound", heresound)
end

function prompt_gag_set(name, line, args)
	local x = string.find(args.prompt, "%%") - 1
	local start = string.sub(args.prompt, 1, x)
	if args.which == "Game" then
		pdata = "^"..string.gsub(start, "[^%a%d%s]", "\\%1")..".+"
	elseif args.which == "Battle" then
		pdata = pdata.."|^"..string.gsub(start, "[^%a%d%s]", "\\%1")..".+"
		--Note("setting gag to: "..pdata)
		SetTriggerOption("match_pdata", "match", pdata)
		SetTriggerOption("match_prompt", "match", pdata)
	end
end

function set_prompt(name, line, args)
	--Note("Setting prompt gag to:  "..string.gsub(line, "[^%a%d%s]", "\\%1"))
	SetTriggerOption("match_prompt", "match", string.gsub(line, "[^%a%d%s]", "\\%1"))
	--EnableTrigger("next_blank_line", true)
end

function page_size(name, line, args)
	if args.lines == "" then
		pagesize = 0
	else
		pagesize = tonumber(args.lines)
		SendNoEcho("pagesize 0")
	end
	if pagesize > 0 then
		ColourNote("white", "", "  Pagesize was ", "cyan", "", pagesize, "white", "", ".  Remembering that setting.\n")
	end
end

function end_page_size(name, line, args)
	if args.paging == "paging" then
		EnableTriggerGroup("pagesize", false)		
		EnableTimer("timer_check_players", true)
		get_player_list()
	end
end

function toggle_sound()
	if playsound == "ON" then
		playsound = "OFF"
	else
		playsound = "ON"
	end
	ColourNote("white", "", "  Who Here sound is ", "cyan", "", playsound, "white", "", ".")
	SaveState()
end

function set_sound(name, line, args)
	heresound = args.file
	ColourNote("white", "", "  Who Here sound set to:")
	ColourNote("white", "", "    ", "cyan", "", heresound)
	SaveState()
end

function ready_player_list(name, line, args)
	players_here = {}
	EnableTriggerGroup("who_where", false)
	EnableTriggerGroup("who_where_player", true)
	if args[1] == "area" then
		end_player_list()
	end
end

function catch_where_list(name, line, args)
	if disabled then
		return
	end
	if not ok_check or checking_where then
		DeleteTimer("re_where")
		AddTimer("re_where", 0, 0, .2, "", 1029, "catch_where_list")
		--DoAfterSpecial(.1, "catch_where_list()", 12)
		return
	end
	if not updating_players then
		--Note("now")
	